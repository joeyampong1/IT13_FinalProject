@page "/create-account"
@layout Layout.EmptyLayout
@using IT_13FinalProject.Services
@using System.ComponentModel.DataAnnotations

<div class="create-account-page">
    <div class="create-account-card">
        <div class="create-account-inner">
            <h2 class="create-account-title">Create User Account</h2>
            <p class="create-account-subtitle">Fill in the details below to add a new MedFlow user.</p>

            <EditForm Model="this" OnValidSubmit="HandleSubmit" OnInvalidSubmit="HandleInvalidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary class="validation-summary" />

                @if (!string.IsNullOrWhiteSpace(FormAlert))
                {
                    <div class="status-message @AlertType">@FormAlert</div>
                }

                <div class="form-grid">
                    <div class="form-field">
                        <label for="nameInput">Full name</label>
                        <InputText id="nameInput" class="form-input" @bind-Value="Name" />
                        <ValidationMessage For="@(() => Name)" />
                    </div>

                    <div class="form-field">
                        <label for="emailInput">Work email</label>
                        <InputText id="emailInput" class="form-input" @bind-Value="Email" type="email" />
                        <div class="form-helper">We’ll use this for important account notices.</div>
                        <ValidationMessage For="@(() => Email)" />
                    </div>

                    <div class="form-field">
                        <label for="usernameInput">Username</label>
                        <InputText id="usernameInput" class="form-input" @bind-Value="UserName" />
                        <ValidationMessage For="@(() => UserName)" />
                    </div>

                    <div class="form-field">
                        <label for="passwordInput">Password</label>
                        <InputText id="passwordInput" class="form-input" @bind-Value="Password" type="password" />
                        <div class="form-helper">Use 8+ characters with a mix of letters and numbers.</div>
                        <ValidationMessage For="@(() => Password)" />
                    </div>

                    <div class="form-field">
                        <label for="confirmPasswordInput">Confirm password</label>
                        <InputText id="confirmPasswordInput" class="form-input" @bind-Value="ConfirmPassword" type="password" />
                        <ValidationMessage For="@(() => ConfirmPassword)" />
                    </div>

                    <div class="form-field">
                        <label for="roleSelect">Role</label>
                        <InputSelect id="roleSelect" class="form-input" @bind-Value="Role">
                            <option value="">Select role</option>
                            <option value="Admin">Admin</option>
                            <option value="Doctor">Doctor</option>
                            <option value="Nurse">Nurse</option>
                            <option value="Billing Staff">Billing Staff</option>
                            <option value="Inventory Staff">Inventory Staff</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => Role)" />
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" @onclick="GoBack" disabled="@IsSubmitting">Back</button>
                    <button type="submit" class="btn-primary" disabled="@IsSubmitting">
                        @(IsSubmitting ? "Creating…" : "Create Account")
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Required(ErrorMessage = "Name is required.")]
    public string? Name { get; set; }

    [Required(ErrorMessage = "Role is required.")]
    public string? Role { get; set; }

    [Required(ErrorMessage = "Email is required.")]
    [EmailAddress(ErrorMessage = "Please enter a valid email address.")]
    public string? Email { get; set; }

    [Required(ErrorMessage = "Username is required.")]
    [MinLength(4, ErrorMessage = "Username must be at least 4 characters.")]
    public string? UserName { get; set; }

    [Required(ErrorMessage = "Password is required.")]
    [StringLength(32, MinimumLength = 8, ErrorMessage = "Password must be between 8 and 32 characters.")]
    public string? Password { get; set; }

    [Required(ErrorMessage = "Please confirm the password.")]
    [Compare(nameof(Password), ErrorMessage = "Passwords do not match.")]
    public string? ConfirmPassword { get; set; }

    private bool IsSubmitting { get; set; }
    private string? FormAlert { get; set; }
    private string AlertType { get; set; } = "info";

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    [Inject]
    private IUserAccountService UserAccountService { get; set; } = default!;

    [Inject]
    private IJSRuntime JsRuntime { get; set; } = default!;

    private void GoBack()
    {
        Navigation.NavigateTo("/login");
    }

    private void HandleInvalidSubmit(EditContext _)
    {
        SetAlert("Please fix the highlighted fields before continuing.", "error");
    }

    private async Task HandleSubmit()
    {
        if (IsSubmitting)
        {
            return;
        }

        IsSubmitting = true;
        SetAlert(null);

        var userName = UserName?.Trim() ?? string.Empty;

        try
        {
            if (UserAccountService.UserExists(userName))
            {
                SetAlert("That username already exists. Please choose another one.", "error");
                return;
            }

            var newUser = new UserAccount
            {
                UserName = userName,
                Password = Password!,
                Role = Role!,
                Name = Name,
                Email = Email
            };

            UserAccountService.AddUser(newUser);

            ResetForm();
            SetAlert("Account created successfully! You can now sign in from the login page.", "success");
        }
        catch (Exception ex)
        {
            SetAlert("Something went wrong while creating the account. Please try again.", "error");
            await JsRuntime.InvokeVoidAsync("console.error", ex.Message);
        }
        finally
        {
            IsSubmitting = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ResetForm()
    {
        Name = string.Empty;
        Email = string.Empty;
        UserName = string.Empty;
        Password = string.Empty;
        ConfirmPassword = string.Empty;
        Role = string.Empty;
    }

    private void SetAlert(string? message, string type = "info")
    {
        FormAlert = message;
        AlertType = type;
    }
}
