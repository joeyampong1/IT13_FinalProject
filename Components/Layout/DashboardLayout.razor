@inherits LayoutComponentBase

<div class="dashboard-layout">
    <aside class="dashboard-sidebar">
        <div class="sidebar-logo">
            <img src="/images/Final_logo-removebg-preview.png" alt="MedFlow Logo" class="sidebar-logo-img" />
            <span class="sidebar-app-name">MedFlow</span>
        </div>

        <nav class="sidebar-section">
            <div class="sidebar-section-title">MAIN</div>
            <button class="sidebar-item @(IsDashboardActive ? "active" : string.Empty)" @onclick="OnDashboardClick">ğŸ  Dashboard</button>
        </nav>

        <nav class="sidebar-section">
            <div class="sidebar-section-title">MODULES</div>

            @* Admin modules *@
            @if (CurrentRole == "Admin")
            {
                <button class="sidebar-item @(IsPatientManagementActive ? "active" : string.Empty)" @onclick="OnPatientManagementClick">ğŸ§‘â€âš•ï¸ Patient Management</button>
                <button class="sidebar-item @(IsHealthRecordActive ? "active" : string.Empty)" @onclick="OnHealthRecordClick">ğŸ“‹ Health Record</button>
                <button class="sidebar-item @(IsInvoicingActive ? "active" : string.Empty)" @onclick="OnInvoicingClick">ğŸ’³ Invoicing &amp; Cashiering</button>
                <button class="sidebar-item">ğŸ§¾ Insurance &amp; Claims</button>
                <button class="sidebar-item">ğŸ’Š Pharmacy &amp; Inventory</button>
                <button class="sidebar-item">ğŸ“Š Reports / Analytics</button>
            }
            @* Nurse modules *@
            else if (CurrentRole == "Nurse")
            {
                <button class="sidebar-item @(IsNursePatientListActive ? "active" : string.Empty)" @onclick="OnNursePatientListClick">ğŸ§‘â€âš•ï¸ Patient List</button>
                <button class="sidebar-item @(IsNurseVitalsActive ? "active" : string.Empty)" @onclick="OnNurseVitalsClick">ğŸ“ˆ Vital Signs Monitoring</button>
                <button class="sidebar-item">â° Medication Schedules</button>
                <button class="sidebar-item">ğŸ“ Nursing Notes</button>
                <button class="sidebar-item">ğŸ“¨ Request</button>
                <button class="sidebar-item">ğŸ“Š Reports</button>
            }
            @* Doctor modules *@
            else if (CurrentRole == "Doctor")
            {
                <button class="sidebar-item @(IsDoctorPatientListActive ? "active" : string.Empty)" @onclick="OnDoctorPatientListClick">ğŸ§‘â€âš•ï¸ Patient List</button>
                <button class="sidebar-item @(IsDoctorHealthRecordActive ? "active" : string.Empty)" @onclick="OnDoctorHealthRecordClick">ğŸ“‹ Health Record</button>
                <button class="sidebar-item">ğŸ“… Appointments</button>
                <button class="sidebar-item">ğŸ’Š Prescriptions</button>
                <button class="sidebar-item">ğŸ§ª Laboratory Results</button>
                <button class="sidebar-item">ğŸ“Š Reports</button>
            }
            @* Billing modules *@
            else if (CurrentRole == "Billing")
            {
                <button class="sidebar-item">ğŸ’³ Billing &amp; Invoicing</button>
                <button class="sidebar-item">ğŸ§¾ Insurance &amp; Claims</button>
                <button class="sidebar-item">ğŸ“Š Reports</button>
            }
            @* Inventory / Pharmacist modules *@
            else if (CurrentRole == "Inventory")
            {
                <button class="sidebar-item">ğŸ¥ Pharmacy Inventory</button>
                <button class="sidebar-item">ğŸ’Š Prescriptions</button>
                <button class="sidebar-item">ğŸ“ˆ Stock Reports</button>
            }
        </nav>

        <nav class="sidebar-section">
            <div class="sidebar-section-title">USER MANAGEMENT</div>

            @* Admin: full user submenu; others: only User Profile *@
            <button class="sidebar-item sidebar-item-expand" @onclick="ToggleUserMenu">
                ğŸ‘¥ User
                <span class="sidebar-chevron">@(IsUserMenuExpanded ? "â–¾" : "â–¸")</span>
            </button>

            @if (IsUserMenuExpanded)
            {
                <button class="sidebar-subitem">ğŸ‘¤ User Profile</button>

                @if (CurrentRole == "Admin")
                {
                    <button class="sidebar-subitem">ğŸ§© Role</button>
                    <button class="sidebar-subitem">ğŸ›¡ï¸ Permission</button>
                }
            }
        </nav>

        <nav class="sidebar-section">
            <div class="sidebar-section-title">SYSTEM</div>
            <button class="sidebar-item">ğŸ“œ Audit Logs</button>
            <button class="sidebar-item">ğŸ”„ Sync Management</button>
            <button class="sidebar-item @(IsSettingsOpen ? "sidebar-item-settings-active" : string.Empty)" @onclick="ToggleSettingsModal">âš™ï¸ Settings</button>
        </nav>

        <button class="sidebar-logout" @onclick="LogoutAsync">LOG OUT</button>
    </aside>

    <div class="@GetDashboardMainClasses()">
        @if (ChildContent is not null)
        {
            @ChildContent
        }
        else
        {
            @Body
        }
    </div>

    @if (IsSettingsOpen)
    {
        <div class="settings-overlay" @onclick="CloseSettingsModal">
            <div class="settings-modal" @onclick:stopPropagation>
                <div class="settings-modal-header">
                    <span class="settings-modal-title">Settings</span>
                    <button class="settings-modal-close" @onclick="CloseSettingsModal">âœ•</button>
                </div>

                <div class="settings-modal-body">
                    <button class="settings-item">ğŸ”” Notification</button>
                    <button class="settings-item" @onclick="ToggleAccessibilityPanel">â™¿ Accessibility</button>
                    <button class="settings-item">ğŸ’¾ Database / Backup</button>
                    <button class="settings-item">âš™ï¸ System Configuration</button>
                </div>
            </div>

            @if (IsAccessibilityOpen)
            {
                <div class="accessibility-modal" @onclick:stopPropagation>
                    <div class="accessibility-header">
                        <span class="accessibility-title">Display</span>
                        <button class="accessibility-close" @onclick="CloseAccessibilityPanel">âœ•</button>
                    </div>

                    <div class="accessibility-section">
                        <div class="accessibility-options">
                            <button class="accessibility-option" @onclick="SetDisplayModeNormal">
                                <span class="accessibility-radio @(CurrentDisplayMode == "Normal" ? "accessibility-radio--selected" : string.Empty)"></span>
                                <span>Normal mode</span>
                            </button>
                            <button class="accessibility-option" @onclick="SetDisplayModeDark">
                                <span class="accessibility-radio @(CurrentDisplayMode == "Dark" ? "accessibility-radio--selected" : string.Empty)"></span>
                                <span>Dark mode</span>
                            </button>
                        </div>
                    </div>

                    <div class="accessibility-section">
                        <div class="accessibility-section-title">Resize Text</div>
                        <div class="accessibility-options">
                            <button class="accessibility-option" @onclick="SetTextSizeSmall">
                                <span class="accessibility-radio @(CurrentTextSize == "Small" ? "accessibility-radio--selected" : string.Empty)"></span>
                                <span>Small</span>
                            </button>
                            <button class="accessibility-option" @onclick="SetTextSizeStandard">
                                <span class="accessibility-radio @(CurrentTextSize == "Standard" ? "accessibility-radio--selected" : string.Empty)"></span>
                                <span>Standard</span>
                            </button>
                            <button class="accessibility-option" @onclick="SetTextSizeLarge">
                                <span class="accessibility-radio @(CurrentTextSize == "Large" ? "accessibility-radio--selected" : string.Empty)"></span>
                                <span>Large</span>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    // JS runtime used to show a simple browser confirm dialog
    [Inject]
    private IJSRuntime JsRuntime { get; set; } = default!;

    private string CurrentRole
    {
        get
        {
            var uri = Navigation.Uri.ToLowerInvariant();

            // Nurse: dashboard + nurse-specific pages
            if (uri.Contains("/nurse-dashboard")
                || uri.Contains("/nurse-patient-list")
                || uri.Contains("/nurse-vitals-list")
                || uri.Contains("/nurse-vitals")
                || uri.Contains("/nurse-patient-profile")
                || uri.Contains("/patient-profile"))
                return "Nurse";

            // Doctor: dashboard and doctor-specific pages
            if (uri.Contains("/doctor-dashboard")
                || uri.Contains("/patient-list")
                || uri.Contains("/doctor-patient-profile")
                || uri.Contains("/doctor-vitals-info")
                || uri.Contains("/doctor-consultation")
                || uri.Contains("/doctor-consultation-edit")
                || uri.Contains("/doctor-health-records"))
                return "Doctor";

            // Billing
            if (uri.Contains("/billing-dashboard"))
                return "Billing";

            // Inventory
            if (uri.Contains("/inventory-dashboard"))
                return "Inventory";

            // Default: Admin dashboard and modules
            return "Admin";
        }
    }

    private bool IsDashboardActive =>
        Navigation.Uri.Contains("/dashboard", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/nurse-dashboard", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/doctor-dashboard", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/billing-dashboard", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/inventory-dashboard", StringComparison.OrdinalIgnoreCase);

    private bool IsPatientManagementActive => Navigation.Uri.Contains("/patient-management", StringComparison.OrdinalIgnoreCase);

    private bool IsNursePatientListActive =>
        Navigation.Uri.Contains("/nurse-patient-list", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.EndsWith("/nurse-vitals", StringComparison.OrdinalIgnoreCase) // Add form belongs under Patient List (but not list/edit)
        || Navigation.Uri.Contains("/nurse-patient-profile", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/patient-profile", StringComparison.OrdinalIgnoreCase);

    private bool IsNurseVitalsActive =>
        Navigation.Uri.Contains("/nurse-vitals-list", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/nurse-vitals-edit", StringComparison.OrdinalIgnoreCase);

    private bool IsDoctorPatientListActive =>
        Navigation.Uri.Contains("/patient-list", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/doctor-patient-profile", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/doctor-vitals-info", StringComparison.OrdinalIgnoreCase)
        // Only the ADD consultation form belongs under Patient List (not the edit page)
        || Navigation.Uri.EndsWith("/doctor-consultation", StringComparison.OrdinalIgnoreCase);

    private bool IsDoctorHealthRecordActive =>
        Navigation.Uri.Contains("/doctor-health-records", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/doctor-consultation-edit", StringComparison.OrdinalIgnoreCase);

    private bool IsHealthRecordActive =>
        Navigation.Uri.Contains("/health-records", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/patient-records", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/patient-ehr-print", StringComparison.OrdinalIgnoreCase);

    private bool IsInvoicingActive =>
        Navigation.Uri.Contains("/invoicing-overview", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/receipt-overview", StringComparison.OrdinalIgnoreCase)
        || Navigation.Uri.Contains("/invoice-pdf", StringComparison.OrdinalIgnoreCase);

    private bool IsUserMenuExpanded { get; set; }
    private bool IsSettingsOpen { get; set; }
    private bool IsAccessibilityOpen { get; set; }

    private string CurrentDisplayMode { get; set; } = "Normal";
    private string CurrentTextSize { get; set; } = "Standard";

    private void OnDashboardClick()
    {
        var target = CurrentRole switch
        {
            "Nurse" => "/nurse-dashboard",
            "Doctor" => "/doctor-dashboard",
            "Billing" => "/billing-dashboard",
            "Inventory" => "/inventory-dashboard",
            _ => "/dashboard"
        };

        Navigation.NavigateTo(target);
    }

    private void OnPatientManagementClick() => Navigation.NavigateTo("/patient-management");

    private void OnNursePatientListClick() => Navigation.NavigateTo("/nurse-patient-list");

    private void OnNurseVitalsClick() => Navigation.NavigateTo("/nurse-vitals-list");

    private void OnDoctorPatientListClick()
    {
        Navigation.NavigateTo("/patient-list");
    }

    private void OnDoctorHealthRecordClick()
    {
        Navigation.NavigateTo("/doctor-health-records");
    }

    private void OnHealthRecordClick() => Navigation.NavigateTo("/health-records");

    private void OnInvoicingClick() => Navigation.NavigateTo("/invoicing-overview");

    private void ToggleUserMenu()
    {
        IsUserMenuExpanded = !IsUserMenuExpanded;
    }

    private void ToggleSettingsModal()
    {
        IsSettingsOpen = !IsSettingsOpen;
        if (!IsSettingsOpen)
        {
            IsAccessibilityOpen = false;
        }
    }

    private void CloseSettingsModal()
    {
        IsSettingsOpen = false;
        IsAccessibilityOpen = false;
    }

    private void ToggleAccessibilityPanel()
    {
        IsAccessibilityOpen = !IsAccessibilityOpen;
    }

    private void CloseAccessibilityPanel()
    {
        IsAccessibilityOpen = false;
    }

    private string GetDashboardMainClasses()
    {
        var classes = "dashboard-main";

        if (CurrentDisplayMode == "Dark")
        {
            classes += " dashboard-main--dark";
        }

        switch (CurrentTextSize)
        {
            case "Small":
                classes += " dashboard-main--text-small";
                break;
            case "Large":
                classes += " dashboard-main--text-large";
                break;
            default:
                // Standard: no extra class needed
                break;
        }

        return classes;
    }

    private void SetDisplayModeNormal() => CurrentDisplayMode = "Normal";

    private void SetDisplayModeDark() => CurrentDisplayMode = "Dark";

    private void SetTextSizeSmall() => CurrentTextSize = "Small";

    private void SetTextSizeStandard() => CurrentTextSize = "Standard";

    private void SetTextSizeLarge() => CurrentTextSize = "Large";

    // Shows a confirmation dialog before navigating back to the login page
    private async Task LogoutAsync()
    {
        var confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to log out?");

        if (confirmed)
        {
            Navigation.NavigateTo("/login", forceLoad: true);
        }
    }
}
